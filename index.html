<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@500;700&display=swap" rel="stylesheet">

        <style>
        body {
            font-family: 'Open Sans', sans-serif;
        }

        .alert {
            padding: 20px;
            background-color: #F44336;
            color: white;
        }
        </style>

        <title>Redirect lezioni</title>
    </head>

    <body>
        <div class="alert" id="no-lesson-found-box" style="display: none">
            <b>Errore!</b> Nessuna lezione trovata.
        </div>

        <noscript>
            <div class="alert">
                <b>Errore!</b> JavaScript richiesto.
            </div>
        </noscript>

        <script>
            const noLessonFoundBox = document.getElementById('no-lesson-found-box');

            const MINUTES_EARLY = 15;
            const WEEK_DAYS = [ 'LUN', 'MAR', 'MER', 'GIO', 'VEN', 'SAB', 'DOM' ];

            const today = new Date(Date.now() + MINUTES_EARLY*60000);
            const todayWeekDay = WEEK_DAYS[today.getDay() - 1];
            const currentHour = today.getHours();

            fetch('https://raw.githubusercontent.com/appinfosapienza/UniBotJS/main/resources/lezioni.json')
                .then(response => response.json())
                .then(timetable => {
                    const currentLesson = timetable.flatMap(lesson => {
                        return lesson.quando.map(quando => ({
                            day: quando[0],
                            from: quando[1],
                            to: quando[2],
                            url: lesson.urlLezione,
                        }));
                    }).filter(lesson => lesson.day === todayWeekDay)
                        .filter(lesson => lesson.from <= currentHour)
                        .filter(lesson => lesson.to > currentHour)[0];

                    if (currentLesson)
                        window.location = currentLesson.url;
                    else
                        noLessonFoundBox.style.display = 'block';
                });
        </script>
    </body>
</html>
